<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QR Scanner</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/zxing/0.18.1/zxing.min.js"></script>
  <style>
    body { text-align: center; padding: 20px; }
    video { width: 100%; max-width: 500px; border: 2px solid #007bff; border-radius: 10px; }
    .hidden { display: none; }
    .animate-scan { animation: blink 0.5s ease-in-out; }
    @keyframes blink { 0% { background-color: #d4edda; } 100% { background-color: transparent; } }
  </style>
</head>
<body>
<h2>QR Code Scanner</h2>
<select id="cameraSelect" class="form-select mb-3"></select>
<video id="qr-video" class="hidden" autoplay></video>
<input type="text" id="qr-result" class="form-control mt-2" placeholder="QR Code Result" readonly>
<div class="mt-3">
  <button id="startScan" class="btn btn-primary">Start Camera</button>
  <button id="stopScan" class="btn btn-danger hidden">Stop Camera</button>
  <button id="clearResult" class="btn btn-warning">Clear</button>
</div>
<audio id="beep" src="https://www.soundjay.com/button/sounds/beep-07.wav"></audio>
<script>
  let selectedDeviceId = localStorage.getItem("selectedCamera") || null;
  let video = document.getElementById("qr-video");
  let resultField = document.getElementById("qr-result");
  let beep = document.getElementById("beep");
  let scannerActive = false;

  async function getCameras() {
    let devices = await navigator.mediaDevices.enumerateDevices();
    let cameras = devices.filter(device => device.kind === "videoinput");
    let select = document.getElementById("cameraSelect");
    select.innerHTML = "";
    cameras.forEach(camera => {
      let option = document.createElement("option");
      option.value = camera.deviceId;
      option.text = camera.label || `Camera ${select.length + 1}`;
      if (camera.deviceId === selectedDeviceId) option.selected = true;
      select.appendChild(option);
    });
  }

  document.getElementById("startScan").addEventListener("click", async () => {
    selectedDeviceId = document.getElementById("cameraSelect").value;
    localStorage.setItem("selectedCamera", selectedDeviceId);
    let constraints = { video: { deviceId: { exact: selectedDeviceId } } };
    let stream = await navigator.mediaDevices.getUserMedia(constraints);
    video.srcObject = stream;
    video.classList.remove("hidden");
    scannerActive = true;
    scanQRCode();
  });

  document.getElementById("stopScan").addEventListener("click", () => {
    stopCamera();
  });

  document.getElementById("clearResult").addEventListener("click", () => {
    resultField.value = "";
    stopCamera();
  });

  function stopCamera() {
    let stream = video.srcObject;
    if (stream) {
      let tracks = stream.getTracks();
      tracks.forEach(track => track.stop());
    }
    video.classList.add("hidden");
    scannerActive = false;
  }

  function scanQRCode() {
    if (!scannerActive) return;
    const codeReader = new ZXing.BrowserMultiFormatReader();
    codeReader.decodeFromVideoDevice(selectedDeviceId, "qr-video", (result, err) => {
      if (result) {
        resultField.value = result.text;
        beep.play();
        resultField.classList.add("animate-scan");
        setTimeout(() => resultField.classList.remove("animate-scan"), 500);
        stopCamera();
      }
    });
  }

  getCameras();
</script>
</body>
</html>
