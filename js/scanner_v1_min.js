const video=document.getElementById("qr-video"),canvas=document.getElementById("qr-canvas"),cameraSelect=document.getElementById("camera-select"),scanSound=document.getElementById("scan-sound");let currentStream=null,selectedCameraId=localStorage.getItem("selectedCameraId"),floatingButton=document.getElementById('floatingButton'),lensMenu=document.getElementById('lensMenu'),Toast=Swal.mixin({toast:!0,position:"bottom-center",showConfirmButton:!1,timer:1500,timerProgressBar:!0,didOpen:toast=>{toast.onmouseenter=Swal.stopTimer,toast.onmouseleave=Swal.resumeTimer}}),camOnOff=!0,classList=['fa-database','fa-user','fa-id-badge','fa-link','fa-wifi','fa-clock','fa-play','fa-sync-alt','fa-calendar-alt','fa-microchip','fa-network-wired','fa-sim-card','fa-tags','fa-barcode','fa-memory','fa-signal','fa-info-circle','fa-file-alt','fa-calendar-check','fa-link','fa-fingerprint','fa-battery-full'],array=[5,7,8,18,19];async function loadCameras(){try{await navigator.mediaDevices.getUserMedia({video:!0});const e=await navigator.mediaDevices.enumerateDevices(),t=e.filter(e=>"videoinput"===e.kind);cameraSelect.innerHTML="",t.forEach((e,a)=>{const o=document.createElement("option");o.value=e.deviceId,o.text=e.label||`Camera ${a+1}`,e.deviceId===selectedCameraId&&(o.selected=!0),cameraSelect.appendChild(o)}),selectedCameraId||t.length<=0||(selectedCameraId=t[0].deviceId,localStorage.setItem("selectedCameraId",selectedCameraId)),await startCamera()}catch(e){console.error("Error loading cameras:",e),alert("Unable to access cameras. Please ensure you have granted permission.")}}async function startCamera(){fadeInQr(),currentStream&&currentStream.getTracks().forEach(e=>e.stop());const e={video:{deviceId:selectedCameraId?{exact:selectedCameraId}:void 0}};try{currentStream=await navigator.mediaDevices.getUserMedia(e),video.srcObject=currentStream,video.play(),scanQRCode()}catch(e){console.error("Error accessing camera:",e),alert("Failed to start the selected camera. Please try another one.")}}function scanQRCode(){const e=canvas.getContext("2d");function t(){video.readyState===video.HAVE_ENOUGH_DATA&&(canvas.hidden=!1,canvas.width=video.videoWidth,canvas.height=video.videoHeight,e.drawImage(video,0,0,canvas.width,canvas.height),requestAnimationFrame(t)}t()}function stopCamera(){currentStream&&(currentStream.getTracks().forEach(e=>e.stop()),currentStream=null,video.srcObject=null}cameraSelect.addEventListener("change",()=>{selectedCameraId=cameraSelect.value,localStorage.setItem("selectedCameraId",selectedCameraId),startCamera(),lensMenu.style.display='none'}),window.addEventListener('load',function(){hideLoader(),camSetting()}),document.getElementById('btnPaste').addEventListener('click',async()=>{try{const e=await navigator.clipboard.readText();document.getElementById('inp').value=formatDeviceId(e)}catch(e){console.error('Failed to paste text: ',e)}}),document.addEventListener('DOMContentLoaded',()=>{const e=document.getElementById('inp');e.addEventListener('input',()=>{e.value=formatDeviceId(e.value)});const t=new MutationObserver(()=>{e.value=formatDeviceId(e.value)});t.observe(e,{attributes:!0,attributeFilter:['value']})}),$("#qrStp").click(function(){camOnOff?(stopCamera(),fadeOutQr(),camOnOff=!1,setCam('false')):(fadeInQr(),loadCameras(),setCam('true'),camOnOff=!0)}),$("#clear").click(function(){clearAll(),stopCamera(),camSetting()}),$("#btnCpy").click(function(){copyToClipboard()}),$('#search').click(function(){searchData()});function convertToBritishTime(e){const t=/_time":\s*"(\d{4}-\d{2}-\d{2})\s(\d{2}):(\d{2}):(\d{2})\sUTC"/g;return e.replace(t,((e,t,a,o,r)=>{const n=new Date(`${t}T${a}:${o}:${r}Z`),s={timeZone:'Europe/London',year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:!0},c=n.toLocaleString('en-GB',s);return`_time": "${c}"`}))}function convertToBritishTime2(e){const t=new Date(e),a=String(t.getDate()).padStart(2,'0'),o=String(t.getMonth()+1).padStart(2,'0'),r=t.getFullYear(),n=t.getHours(),s=String(t.getMinutes()).padStart(2,'0'),c=String(t.getSeconds()).padStart(2,'0'),i=n>=12?'PM':'AM',d=n%12||12,l=String(d).padStart(2,'0');return`${a}/${o}/${r} ${l}:${s}:${c} ${i}`}function hideLoader(){$("#inner-box").css('display','none')}function showLoader(){$("#inner-box").css('display','block')}function clearTable(){$("#tb").empty(),$('#f-deviceData').empty()}function searchData(){clearTable(),showLoader();const e=$("#inp").val();$.ajax({url:`https://tools.afreespace.com/bless/debug.php?id=${e}`,success:function(e){hideLoader(),$('#f-deviceData').empty(),$('#deviceData').empty();let t=convertToBritishTime(e),a=t.replace(/<hr\/>/g,'<br/>').replace(/<hr>/g,'<br/>').replace(/"/g,'').replace(/,/g,'').replace(/\n/g,'').replace(/}/g,'').replace(/{/g,'').replace(/_/g,' ').replace(/\\/g,''),o=a.split('<br/>'),r=0;for(let t=0;t<o.length;t++)if(t<21){let a=o[t].split(/:(.+)/);if(0===t&&(a[0]="Device Type",(e=o[t].match(/PT:\s*([\w\s]+)/))?a[1]=e[1]:a[1]="..."),3===t&&(a[1]=`<a class="la" target="_blank" href="${a[1]}">Visit Agent</a>`),4===t){let e=JSON.parse(a[1].toLowerCase().trim());a[1]=e?'<span class="badge bg-primary">True</span>':'<span class="badge bg-danger">False</span>'}if(6===t){let e=JSON.parse(a[1].toLowerCase().trim());a[1]=e?'<span class="badge bg-primary">True</span>':'<span class="badge bg-danger">False</span>'}array.includes(t)&&(a[1]=convertToBritishTime2(a[1]));let e=`<div class="info-section"><div class="info-section-header"><i class="fas ${classList[t]}"></i>${a[0].toUpperCase()}</div><div class="info-section-value">${a[1]}</div></div>`;$('#f-deviceData').append(e)}else if(21===t){let e=t.replace(/<hr\/>/g,'<br/>').replace(/<hr>/g,'<br/>').replace(/_/g,' '),a=e.split('<br/>'),o=a[t],r=o.match(/"battery":\s*([\d.]+)/);try{let e=`<div class="info-section"><div class="info-section-header"><i class="fas ${classList[t]}"></i>${'battery'.toUpperCase()}</div><div class="info-section-value">${r[1]}</div></div>`;$('#f-deviceData').append(e)}catch(e){console.log("No Battery Found")}try{const e=o.match(/{.*}/)[0],t=JSON.parse(e);function a(e,t){for(const a in e){const o=e[a],r=document.createElement("div");r.className="d_wrapper";if("object"==typeof o&&null!==o){const e=document.createElement("span");e.className="json-key",e.textContent=`${a.toUpperCase()}: `;const o=document.createElement("div");o.className="json-object",a(o,o),r.appendChild(e),r.appendChild(o)}else{const e=document.createElement("span");e.className="json-key",e.textContent=`${a.toUpperCase()}: `;const o=document.createElement("span");o.className="json-value",o.textContent=o,r.appendChild(e),r.appendChild(o)}t.appendChild(r)}}const o=document.getElementById("deviceData");a(t,o)}catch(e){let t=$(".la");t.css('color','red'),t.text('Link is Not Working')}}else o[t]&&(r++,$("#tb").prepend(`<tr><td>${r}</td><td>${o[t]}</td></tr>`))}},error:function(e){hideLoader(),alert("Something Wrong - Check ID"),clearAll()}})}function fadeOutQr(){$("#camera-select").css('display','none'),$("#floatingButton").css('display','none'),$("#qr-video").css('display','none')}function fadeInQr(){$("#camera-select").css('display','block'),$("#floatingButton").css('display','flex'),$("#qr-video").css('display','block')}function clearAll(){clearTable(),$("#inp").val(""),$("#inp").focus(),$('#deviceData').empty(),$('#f-deviceData').empty()}function copyToClipboard(){const e=document.getElementById("inp");e.focus(),e.select(),e.setSelectionRange(0,99999),navigator.clipboard&&navigator.clipboard.writeText?navigator.clipboard.writeText(e.value).then(()=>{Toast.fire({icon:"success",title:"Copied : "+e.value})}).catch(e=>{console.log(e)}):void 0}function getDeviceID(e){$.ajax({url:e.replace("http://","https://"),success:function(e){let t=$(e).find('#temp-table').children('tbody').children('tr:nth-child(1)').children('td:nth-child(2)').text();$('#inp').val(formatDeviceId(t)),copyToClipboard(),searchData(),stopCamera(),fadeOutQr()}})}function camSetting(){let e=localStorage.getItem('cam4');null==e?(camOnOff=!0,localStorage.setItem('cam4','true'),loadCameras(),updateButton(!0)):"true"===e?(loadCameras(),camOnOff=!0,updateButton(!0)):"false"===e&&(camOnOff=!1,updateButton(!1))}function setCam(e){localStorage.setItem('cam4',e),"true"===e?updateButton(!0):"false"===e&&updateButton(!1)}function updateButton(e){const t=document.getElementById("qrStp");e?t.textContent="Cam : Off":t.textContent="Cam : On"}function formatDeviceId(e){return e=e.replace(/[^0-9]/g,''),e.length>4&&(e=e.slice(0,4)+'-'+e.slice(4)),e.length>8&&(e=e.slice(0,8)+'-'+e.slice(8)),e.slice(0,12)}floatingButton.addEventListener('click',()=>{"block"===lensMenu.style.display?lensMenu.style.display='none':lensMenu.style.display='block'});